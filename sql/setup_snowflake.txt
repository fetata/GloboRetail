

CREATE OR REPLACE ROLE GLOBO_RETAIL_ROLE;



CREATE OR REPLACE WAREHOUSE GLOBO_RETAIL_WH
WITH
    WAREHOUSE_SIZE = 'XSMALL'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE;



CREATE OR REPLACE DATABASE GLOBO_RETAIL_DB;




USE DATABASE GLOBO_RETAIL_DB;

CREATE OR REPLACE SCHEMA STAGING;
CREATE OR REPLACE SCHEMA CLEANSED;
CREATE OR REPLACE SCHEMA STAR;
CREATE OR REPLACE SCHEMA PRESENTATION;



GRANT USAGE ON WAREHOUSE GLOBO_RETAIL_WH TO ROLE GLOBO_RETAIL_ROLE;
GRANT ALL ON DATABASE GLOBO_RETAIL_DB TO ROLE GLOBO_RETAIL_ROLE;
GRANT ALL ON ALL SCHEMAS IN DATABASE GLOBO_RETAIL_DB TO ROLE GLOBO_RETAIL_ROLE;



USE SCHEMA GLOBO_RETAIL_DB.STAGING;

CREATE OR REPLACE FILE FORMAT CSV_FILE_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
NULL_IF = ('NULL', 'null', '');



CREATE OR REPLACE STAGE S3_CLEAN_STAGE
URL = 's3://softuni-exam-etl/clean/'
CREDENTIALS = (
	-- AWS credentials are required to load data from S3
	-- They must be provided via environment variables:

	-- AWS_ACCESS_KEY_ID
	-- AWS_SECRET_ACCESS_KEY

)
FILE_FORMAT = CSV_FILE_FORMAT;



USE SCHEMA GLOBO_RETAIL_DB.CLEANSED;
CREATE OR REPLACE TABLE SALES_CLEAN (
    sales_id INTEGER,
    product_id INTEGER,
    region STRING,
    quantity INTEGER,
    price NUMBER(10,2),
    discount NUMBER(5,2),
    order_status STRING,
    timestamp TIMESTAMP_NTZ,
    total_sales NUMBER(12,2)
);

CREATE OR REPLACE TABLE PRODUCTS_CLEAN (
    product_id INTEGER,
    category STRING,
    brand STRING,
    rating NUMBER(3,2),
    in_stock BOOLEAN,
    launch_date DATE
);


USE DATABASE GLOBO_RETAIL_DB;
USE SCHEMA CLEANSED;

COPY INTO SALES_CLEAN
FROM @GLOBO_RETAIL_DB.STAGING.S3_CLEAN_STAGE/sales_clean.csv
FILE_FORMAT = (
    TYPE = 'CSV'
    SKIP_HEADER = 1
    FIELD_OPTIONALLY_ENCLOSED_BY = '"'
)
ON_ERROR = 'CONTINUE';

SELECT * FROM GLOBO_RETAIL_DB.CLEANSED.SALES_CLEAN;

USE DATABASE GLOBO_RETAIL_DB;
USE SCHEMA CLEANSED;

COPY INTO PRODUCTS_CLEAN
FROM @GLOBO_RETAIL_DB.STAGING.S3_CLEAN_STAGE/products_clean.csv
FILE_FORMAT = (
    TYPE = 'CSV'
    SKIP_HEADER = 1
    FIELD_OPTIONALLY_ENCLOSED_BY = '"'
)
ON_ERROR = 'CONTINUE';

SELECT * FROM GLOBO_RETAIL_DB.CLEANSED.PRODUCTS_CLEAN;


USE DATABASE GLOBO_RETAIL_DB;
USE SCHEMA STAR;


CREATE OR REPLACE TABLE DIM_DATE AS
SELECT DISTINCT
    CAST(timestamp AS DATE) AS date_id,
    CAST(timestamp AS DATE) AS full_date,
    YEAR(timestamp) AS year,
    MONTH(timestamp) AS month,
    TO_CHAR(timestamp, 'Month') AS month_name,
    WEEK(timestamp) AS week,
    DAY(timestamp) AS day,
    DAYNAME(timestamp) AS weekday
FROM CLEANSED.SALES_CLEAN;


CREATE OR REPLACE TABLE DIM_PRODUCT AS
SELECT DISTINCT
    product_id
FROM CLEANSED.SALES_CLEAN;


CREATE OR REPLACE TABLE FACT_SALES AS
SELECT
    sales_id,
    product_id,
    CAST(timestamp AS DATE) AS date_id,
    region,
    quantity,
    price,
    discount,
    total_sales
FROM CLEANSED.SALES_CLEAN;

SELECT COUNT(*) FROM STAR.DIM_DATE;
SELECT COUNT(*) FROM STAR.DIM_PRODUCT;
SELECT COUNT(*) FROM STAR.FACT_SALES;

SELECT * FROM STAR.FACT_SALES LIMIT 10;

USE DATABASE GLOBO_RETAIL_DB;
USE SCHEMA PRESENTATION;


CREATE OR REPLACE MATERIALIZED VIEW MV_SALES_BY_REGION_MONTH AS
SELECT
    region,
    DATE_TRUNC('MONTH', date_id) AS month,
    SUM(total_sales) AS total_revenue,
    SUM(quantity) AS total_quantity
FROM STAR.FACT_SALES
GROUP BY region, DATE_TRUNC('MONTH', date_id);

CREATE OR REPLACE MATERIALIZED VIEW MV_TOP_PRODUCTS_BY_REVENUE AS
SELECT
    product_id,
    SUM(total_sales) AS total_revenue,
    SUM(quantity) AS total_quantity
FROM STAR.FACT_SALES
GROUP BY product_id;


SELECT *
FROM MV_TOP_PRODUCTS_BY_REVENUE
ORDER BY total_revenue DESC
LIMIT 5;

CREATE OR REPLACE MATERIALIZED VIEW MV_REVENUE_TREND AS
SELECT
    date_id,
    SUM(total_sales) AS daily_revenue
FROM STAR.FACT_SALES
GROUP BY date_id;



CREATE OR REPLACE MATERIALIZED VIEW MV_CATEGORY_PERFORMANCE AS
SELECT
    product_id AS category_id,
    SUM(total_sales) AS total_revenue,
    SUM(quantity) AS total_quantity
FROM STAR.FACT_SALES
GROUP BY product_id;


SHOW MATERIALIZED VIEWS IN SCHEMA PRESENTATION;

SELECT * FROM MV_SALES_BY_REGION_MONTH LIMIT 10;
SELECT * FROM MV_TOP_PRODUCTS_BY_REVENUE LIMIT 10;
SELECT * FROM MV_REVENUE_TREND LIMIT 10;
SELECT * FROM MV_CATEGORY_PERFORMANCE LIMIT 10;

